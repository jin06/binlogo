MySql Replication （MySql的主从复制）
=========

[English](../en/Mysql-Replication.md)

> MySql的主从节点同步数据的机制叫做replication。简单来说，主节点会记录二进制日志（数据的增量变化），通过某种方式将这些数据同步给从节点，达到数据同步的目的。
> 
> 大量的Mysql数据同步到其他异构数据的应用场景都会利用MySql的replication实现，因为该方式可以达到准实时、稳定性也很好。
> 其基本原理是，MySql服务器会把数据的变更、表结构的变更记录到日志文件中，也就是binlog，从库只要拿到这些日志文件就可以将主库的数据同步过来。
> 同样的，基于binlog日志的一些围绕MySql的中间件通过获取binlog就可以得到MySql的数据变化的信息。
> 
> 做一个获取MySql增量信息的工具就要稍微了解一下MySql的binlog以及同步的方式。
>> 例如主库和从库同步数据的时候通信过程是怎么样的，怎么建立的连接，是主库主动发送binlog还是从库主动拉取。
>
>> binlog是二进制文件，不能像普通的文本文件一样直接读取。其实也不是十分必要了解它的物理组织方式，因为已经有很多开源代码可以做解析。
> 
>> 要了解BinlogEvent，这是一个重要的逻辑概念，BinlogEvent就是binlog记录的内容，要了解它的基本概念和有哪些版本。不同的MySql版本之间的差异。
> 
>> Mysql 配置相关的东西，如开启binlog记录，记录的方式。
> 
>> 伪装成从库的工具对于MySql主库的影响，比如MySql主从复制中会有半同步复制

> 总结一下，写这个工具要考虑的问题就是：1. binlog的基本原理 2. 不同MySql版本之间的差异（binlogEvent、GTID）3. Mysql主库要做的配置  4. 工具对于Mysql的影响


### 1. Binlog 基本原理
#### 1.1 Mysql建立连接的过程，同步binlog日志的过程
> MySQL的主从复制很简单，首先是从服务器主动和主服务器建立连接，并将需要读取的binlog位置发送给主服务器。
> 建立连接后，主服务器有新产生的binlog日志，会主动发送给从服务器。
> 其中主服务会为这个从服务器单独开启一个线程，而从服务器会有两个线程，
> 一个是负责IO的线程，把主服务器发送的binlog存储在本地的中继日志中，另一个是负责数据恢复的线程。
> 
> 所以同步工具也是类似的，建立连接同步binlog数据，然后解析binlog数据转化成应用易于处理的格式（例如json），然后将数据输出到其他地方（消息队列）。
> 翻阅资源发现，主库不会持久存储主从复制过程中binlog的位置信息，当发生中断时，这个同步到什么位置的信息就丢失了，所以同步工具要持久的保存binlog的位置信息。
> 同步工具在binlog日志同步过程中，解决三个问题，一个是同步binlog，一个是持久化存储binlog位置信息，一个是不能多个同步工具的一致性（同步一次并且只能同步一次）。
> 
> 补充：
>   1. 很多网上的资料说是每次都是从库主动拉取binlog的日志，这点与自己的实践是相悖的。
>   我们使用MySQL时很多时候都会用到读写分离的场景，写主库，读从库。在使用过程中没有发现从库有明显的延迟。
> 如果是从库定时拉取，很可能是秒级别的延迟。使用`show processlist` 分别查看主库和从库的IO线程发现，主库显示的状态有可能是
> `... waiting for binlog to updated`，从库显示有可能是`... Waiting for master to send event ...`.
> 结合官方资料判断，是主库主动发送binlog给从库，而从库每次处理完以后会保存一下位置信息，在连接断掉重连时使用。相信MySQL的作者也不会想到
> 让从库每次去拉取信息，从库主动拉取势必导延迟更久，主从数据不一致时间更久一点；主库主动推送，可以让主库更容易判断从库的状态，不用额外的去写逻辑判断。
> 
### 2. 不同Mysql之间的差异
#### 2.1 市面上的Mysql版本
##### 2.1.1 MariaDB 与 Mysql 

> 

#####  2.1.2 Mysql 各个版本
> 主流云厂商(全球前4)对于mysql的支持：
> -  亚马逊 AWS: 5.6 至 8 
> -  微软 Azure: 5.6 至 8  
> -  谷歌 : 没查到数据
> -  阿里云: 的Mysql实例支持5.5 到 8之间的版本。
> 
> 没有查询到mysql各个版本用户存量数据，查询发行时间，Mysql5.5 发行时间在2009年，结合云厂商的数据，考虑这个数据同步的项目支持的Mysql最低版本为5.5 。 
> 

#### 2.2 GTID
#### 2.3 binglog event 版本

### 3. Mysql的配置
#### 3.1 binlog日志格式
> Mysql 的三种binlog日志格式statement、row、mixed。
> 
> statement是记录sql语句；row模式记录每条数据具体的变化；mixed介于两者之间，会根据不同的sql在statement和row之间选择。
> 
> 所以需要将binlog的日志格式配置成row，因为这种模式的binlog会记录每一行数据的变化。但是也有一些情况是记录不到的，例如在变更数据表结构时添加新的字段并赋予一个默认值的情况就只会记录这个sql，而不会将以往数据的变化都记录一份。
> 

### 4. 工具对于Mysql的影响、风险
#### 4.1 对于MySQL主服务器性能的影响
> 由于MySQL主从复制时，主服务器需要开启一个工作线程将binlog发送给从服务器，参考MySQL官方网站和实际测试发现，针对每一个从服务器，MySQL主库会开启一个独立的线程做binlog的同步工作。
> 
> 在同步过程中也会有一些网络的开销。
> 
> 所以如果对于一个相同的主库开启了过多的从库（或类似从库的工具）就会对主库的性能有影响，尤其是在从库（或工具）很多和大批量修改时。
> 但是，一般情况数据修改的逻辑会牵涉更多的工作，例如一个全表的update操作，要涉及到修改存储数据的文件，主键索引树上的数据要修改，还有很多逻辑操作，相反，binlog是顺序的写，发送binlog到从库的操作消耗的资源很少，性能上不会对主库造成很大的影响。
> 
> 
#### 4.2 一个伪装成slave的中间件对于原有的Mysql主从复制的影响

